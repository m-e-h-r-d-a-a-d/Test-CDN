<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDN Functionality Tester</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ CDN Functionality Tester</h1>
            <p>Test all VergeCloud and ArvanCloud features with one click</p>
        </div>
        
        <!-- Main Grid Layout -->
        <div class="main-grid">
            <!-- Left Column: Control Panel -->
            <div class="card">
                <h2>‚öôÔ∏è Test Configuration</h2>

                <div class="control-panel">
                    <!-- Number of Rounds -->
                    <div class="form-group">
                        <label for="rounds">Number of Rounds</label>
                        <input id="rounds" type="number" value="3" min="1" max="10" />
        </div>
        
                    <!-- Delay Between Tests -->
                    <div class="form-group">
                        <label for="delay">Delay Between Tests (seconds)</label>
                        <input id="delay" type="number" value="2" min="0" max="10" step="0.5" />
        </div>
        
                    <!-- Complete CDN Test Description -->
                    <div class="test-description">
                        <h3>üß™ Complete CDN Functionality Test</h3>
                        <p>This comprehensive test evaluates all aspects of CDN providers:</p>
                        <div class="test-features">
                            <div class="feature-item">
                                <span class="feature-icon">‚ö°</span>
                                <span>Frontend Performance</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon">üõ°Ô∏è</span>
                                <span>Security & WAF</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon">üîå</span>
                                <span>API Functionality</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon">üìä</span>
                                <span>Feature Comparison</span>
                            </div>
                        </div>
                        <p><strong>Tests both VergeCloud and ArvanCloud to determine which features each provider actually supports.</strong></p>
        </div>
        
                    <!-- Run Button -->
                    <button class="btn btn-primary" onclick="startTests()" id="runBtn">
                        ‚ñ∂Ô∏è START TESTS
                </button>
                </div>
            </div>
            
            <!-- Right Column: Results -->
            <div class="card">
                <h2>üìä Results</h2>

                <!-- Progress Section -->
                <div id="progressSection" style="display: none;">
                    <div class="progress-container">
                        <div class="progress-label">
                            <span class="label-text">Testing Progress</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>
                    <div class="status-box">
                        <p class="status-text" id="statusMessage">üîÑ Starting tests...</p>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div id="resultsSection" class="results-section">
                    <!-- Summary Cards -->
                    <div class="summary-cards">
                        <div class="summary-card direct">
                            <div class="emoji">üñ•Ô∏è</div>
                            <div class="provider-name">Direct Server</div>
                            <div class="score" id="directScore">0/0</div>
                            <div class="score-label">Features Working</div>
                        </div>

                        <div class="summary-card verge">
                            <div class="emoji">üåê</div>
                            <div class="provider-name">VergeCloud</div>
                            <div class="score" id="vergeScore">0/0</div>
                            <div class="score-label">Features Working</div>
                        </div>

                        <div class="summary-card arvan">
                            <div class="emoji">‚òÅÔ∏è</div>
                            <div class="provider-name">ArvanCloud</div>
                            <div class="score" id="arvanScore">0/0</div>
                            <div class="score-label">Features Working</div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="legend">
                        <h4>Status Indicators:</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-box success"></div>
                                <span>‚úÖ Working</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box security"></div>
                                <span>üõ°Ô∏è Security Blocked (Good!)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box warning"></div>
                                <span>‚ö†Ô∏è Issues</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box error"></div>
                                <span>‚ùå Failing</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box loading"></div>
                                <span>‚è≥ Testing</span>
                            </div>
                        </div>
                    </div>

                    <!-- Results Table -->
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Test Category</th>
                                <th style="text-align: center;">Direct</th>
                                <th style="text-align: center;">VergeCloud</th>
                                <th style="text-align: center;">ArvanCloud</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>

                    <!-- Issues Section -->
                    <div class="issues-section" id="issuesSection">
                        <h4>‚ö†Ô∏è Issues Found:</h4>
                        <ul class="issues-list" id="issuesList"></ul>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="location.reload()">
                            üîÑ Test Again
                        </button>
                        <button class="btn btn-info" id="exportBtn" onclick="exportTestReport()" style="display: none;">
                            üìä Export Report
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('resultsSection').classList.remove('active'); document.getElementById('progressSection').style.display='none';">
                            ‚óÄ Back
                        </button>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState">
                    <p style="text-align: center; color: #999; padding: 40px 0;">
                        üëà Configure tests on the left and click START TESTS to begin
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Quick Links at Bottom -->
        <div style="text-align: center; margin-top: 40px; color: white;">
            <p>üìñ <a href="./tests/manual.html" style="color: white; text-decoration: underline;">Manual Testing Guide</a> ‚Ä¢ 
               üìö <a href="./tests/auto.html" style="color: white; text-decoration: underline;">Advanced Test Runner</a></p>
        </div>
    </div>

    <script>
        async function startTests() {
            const rounds = parseInt(document.getElementById('rounds').value) || 1;
            const delay = parseFloat(document.getElementById('delay').value) || 1;

            const runBtn = document.getElementById('runBtn');
            const progressSection = document.getElementById('progressSection');
            const resultsSection = document.getElementById('resultsSection');
            const emptyState = document.getElementById('emptyState');

            runBtn.disabled = true;
            progressSection.style.display = 'block';
            emptyState.style.display = 'none';
            resultsSection.classList.remove('active');

            try {
                await runTests(rounds, delay);
                resultsSection.classList.add('active');
            } finally {
                runBtn.disabled = false;
                progressSection.style.display = 'none';
            }
        }

        async function runTests(rounds, delay) {
            // Clear previous results
            window.testResults = [];
            document.getElementById('exportBtn').style.display = 'none';

            const endpoints = getEndpoints();
            const providers = [
                { id: 'direct', name: 'Direct', url: 'https://142.93.208.111' },
                { id: 'verge', name: 'VergeCloud', url: 'https://test-verge-test.shop' },
                { id: 'arvan', name: 'ArvanCloud', url: 'https://test20250316.ir' }
            ];

            const times = { direct: [], verge: [], arvan: [] };
            const scores = { direct: 0, verge: 0, arvan: 0 };

            // Calculate total tests correctly
            let totalTests = 0;
            for (const endpoint of endpoints) {
                if (endpoint.category === 'api') {
                    // API tests count as 3 tests (Direct + 2 providers)
                    totalTests += 3 * rounds;
                } else {
                    // Regular tests count as 3 tests per provider
                    totalTests += providers.length * rounds;
                }
            }
            let completedTests = 0;

            const resultsTable = document.getElementById('resultsTable');
            resultsTable.innerHTML = '';

            // Initialize results table with categories
            let currentCategory = '';
            for (const endpoint of endpoints) {
                // Add category header if category changed
                if (endpoint.category !== currentCategory) {
                    currentCategory = endpoint.category;
                    const categoryRow = document.createElement('tr');
                    categoryRow.className = 'category-row';
                    categoryRow.innerHTML = `
                        <td colspan="4" class="category-header">
                            <strong>${getCategoryDisplayName(endpoint.category)}</strong>
                        </td>
                    `;
                    resultsTable.appendChild(categoryRow);
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="endpoint">${endpoint.name}</td>
                    <td class="status" id="direct-${endpoint.id}"><span class="status-indicator loading">‚è≥</span></td>
                    <td class="status" id="verge-${endpoint.id}"><span class="status-indicator loading">‚è≥</span></td>
                    <td class="status" id="arvan-${endpoint.id}"><span class="status-indicator loading">‚è≥</span></td>
                `;
                resultsTable.appendChild(row);
            }

            // Run tests
            for (let round = 0; round < rounds; round++) {
                for (const endpoint of endpoints) {
                    if (endpoint.category === 'api') {
                        // API tests work differently - one test per endpoint, tests both providers
                        const url = `https://142.93.208.111${endpoint.path}`;
                        const start = Date.now();
                        const success = await testEndpoint(url);
                        const duration = Date.now() - start;

                        // Find the result for this URL
                        const result = window.testResults[window.testResults.length - 1];

                        if (success) {
                            // API test success means at least one provider worked
                            scores.direct++; // Count as success for Direct (our proxy)
                            document.getElementById(`direct-${endpoint.id}`).innerHTML = '<span class="status-indicator success" title="API test successful">‚úÖ</span>';

                            // Mark both providers based on API results
                            const vergeSuccess = result.apiResults?.find(r => r.provider === 'vergecloud')?.success;
                            const arvanSuccess = result.apiResults?.find(r => r.provider === 'arvancloud')?.success;

                            if (vergeSuccess) {
                                scores.verge++;
                                document.getElementById(`verge-${endpoint.id}`).innerHTML = '<span class="status-indicator success" title="API working">‚úÖ</span>';
                            } else {
                                document.getElementById(`verge-${endpoint.id}`).innerHTML = '<span class="status-indicator error" title="API not accessible">‚ùå</span>';
                            }

                            if (arvanSuccess) {
                                scores.arvan++;
                                document.getElementById(`arvan-${endpoint.id}`).innerHTML = '<span class="status-indicator success" title="API working">‚úÖ</span>';
                            } else {
                                document.getElementById(`arvan-${endpoint.id}`).innerHTML = '<span class="status-indicator error" title="API not accessible">‚ùå</span>';
                            }
                        } else {
                            // All failed
                            document.getElementById(`direct-${endpoint.id}`).innerHTML = '<span class="status-indicator error" title="API test failed">‚ùå</span>';
                            document.getElementById(`verge-${endpoint.id}`).innerHTML = '<span class="status-indicator error" title="API not accessible">‚ùå</span>';
                            document.getElementById(`arvan-${endpoint.id}`).innerHTML = '<span class="status-indicator error" title="API not accessible">‚ùå</span>';
                        }

                        completedTests += 3; // Count as testing all 3 providers
                        document.getElementById('statusMessage').textContent = `üîå Testing ${endpoint.name} API... (${completedTests}/${totalTests})`;
                    } else {
                        // Regular tests - one per provider
                        for (const provider of providers) {
                            const url = provider.url + endpoint.path;
                            const start = Date.now();
                            const success = await testEndpoint(url);
                            const duration = Date.now() - start;

                            // Find the result for this URL
                            const result = window.testResults[window.testResults.length - 1];

                            if (success) {
                                times[provider.id].push(duration);
                                scores[provider.id]++;

                                if (result.blockedBySecurity) {
                                    // Security blocking is good for ArvanCloud
                                    document.getElementById(`${provider.id}-${endpoint.id}`).innerHTML = '<span class="status-indicator security" title="Blocked by security (good!)">üõ°Ô∏è</span>';
                                } else {
                                    document.getElementById(`${provider.id}-${endpoint.id}`).innerHTML = '<span class="status-indicator success" title="Working correctly">‚úÖ</span>';
                                }
                            } else {
                                document.getElementById(`${provider.id}-${endpoint.id}`).innerHTML = '<span class="status-indicator error" title="Not working">‚ùå</span>';
                            }

                            completedTests++;
                            document.getElementById('statusMessage').textContent = `üîÑ Testing ${endpoint.name} on ${provider.name}... (${completedTests}/${totalTests})`;
                        }
                    }

                    const progress = Math.round((completedTests / totalTests) * 100);
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressText').textContent = progress + '%';
                }

                if (round < rounds - 1) {
                    await new Promise(r => setTimeout(r, delay * 1000));
                }
            }

            // Update scores
            const totalPerProvider = endpoints.length * rounds;
            document.getElementById('directScore').textContent = `${scores.direct}/${totalPerProvider}`;
            document.getElementById('vergeScore').textContent = `${scores.verge}/${totalPerProvider}`;
            document.getElementById('arvanScore').textContent = `${scores.arvan}/${totalPerProvider}`;

            document.getElementById('statusMessage').innerHTML = '<span class="status-indicator success">‚úÖ All tests completed!</span>';

            // Show export button
            document.getElementById('exportBtn').style.display = 'inline-block';

            // Check for issues
            const issues = [];
            if (scores.verge < totalPerProvider * 0.7) {
                issues.push('VergeCloud: Multiple tests failing - check configuration');
            }
            if (scores.arvan < totalPerProvider * 0.7) {
                issues.push('ArvanCloud: Multiple tests failing - check configuration');
            }

            const issuesSection = document.getElementById('issuesSection');
            const issuesList = document.getElementById('issuesList');
            if (issues.length > 0) {
                issuesList.innerHTML = issues.map(i => `<li>${i}</li>`).join('');
                issuesSection.classList.add('active');
            } else {
                issuesSection.classList.remove('active');
            }
        }

        async function testEndpoint(url) {
            try {
                const startTime = Date.now();

                // Check if this is an API test (different handling)
                const isApiTest = url.includes('/api-test/');

                let response;
                if (isApiTest) {
                    // For API tests, we need to test both providers
                    const providers = ['vergecloud', 'arvancloud'];
                    const results = [];

                    for (const provider of providers) {
                        const apiUrl = `${url}?provider=${provider}`;
                        try {
                            const apiResponse = await fetch(apiUrl, {
                                method: 'GET',
                                mode: 'cors',
                                cache: 'no-cache'
                            });

                            const apiData = await apiResponse.json();
                            results.push({
                                provider: provider,
                                success: apiData.success,
                                status: apiResponse.status,
                                data: apiData
                            });
                        } catch (apiError) {
                            results.push({
                                provider: provider,
                                success: false,
                                status: 'ERROR',
                                error: apiError.message
                            });
                        }
                    }

                    const endTime = Date.now();
                    const duration = endTime - startTime;

                    // API test is successful if at least one provider works
                    const effectiveSuccess = results.some(r => r.success);

                    const result = {
                        url: url,
                        status: 'API_TEST',
                        statusText: 'API endpoints tested',
                        duration: duration,
                        success: effectiveSuccess,
                        apiResults: results,
                        isApiTest: true
                    };

                    if (!window.testResults) window.testResults = [];
                    window.testResults.push(result);

                    return effectiveSuccess;
                } else {
                    // Regular endpoint testing
                    response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                }

                const endTime = Date.now();
                const duration = endTime - startTime;

                // Check if this is a security test that should be blocked
                const isSecurityTest = url.includes('/security/');
                const isArvanCloud = url.includes('test20250316.ir');

                // For ArvanCloud security tests, blocking is actually success
                const effectiveSuccess = response.ok || (isArvanCloud && isSecurityTest && response.status === 0);

                // Store detailed result for reporting
                const result = {
                    url: url,
                    status: response.status,
                    statusText: response.statusText,
                    duration: duration,
                    success: effectiveSuccess,
                    blockedBySecurity: isArvanCloud && isSecurityTest && !response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                };

                // Add to global results array
                if (!window.testResults) window.testResults = [];
                window.testResults.push(result);

                return effectiveSuccess;
            } catch (error) {
                // Store error result for reporting
                const isSecurityTest = url.includes('/security/');
                const isArvanCloud = url.includes('test20250316.ir');

                // For ArvanCloud security tests, network errors might be security blocking
                const effectiveSuccess = isArvanCloud && isSecurityTest;

                const result = {
                    url: url,
                    status: 'ERROR',
                    statusText: error.message,
                    duration: 0,
                    success: effectiveSuccess,
                    blockedBySecurity: isArvanCloud && isSecurityTest,
                    error: error.message
                };

                if (!window.testResults) window.testResults = [];
                window.testResults.push(result);

                return effectiveSuccess;
            }
        }

        function getCategoryDisplayName(category) {
            const names = {
                'performance': '‚ö° Frontend Performance',
                'caching': 'üíæ Caching & Headers',
                'security': 'üõ°Ô∏è Security & WAF',
                'features': 'üîß Additional Features',
                'api': 'üîå API Functionality'
            };
            return names[category] || category;
        }

        function getEndpoints() {
            // Complete test suite - frontend + security + API testing
            const frontendEndpoints = [
                { id: 'root', name: 'Root Page', path: '/', category: 'performance' },
                { id: 'large', name: 'Large File', path: '/large-probe.txt', category: 'performance' },
                { id: 'small', name: 'Small File', path: '/probe.txt', category: 'performance' },
                { id: 'cache-time', name: 'Cache Headers', path: '/api/time', category: 'caching' },
                { id: 'cache-bypass', name: 'Cache Bypass', path: '/cache/bypass/nocache', category: 'caching' },
                { id: 'sql', name: 'Security - SQL', path: '/security/sql/union', category: 'security' },
                { id: 'xss', name: 'Security - XSS', path: '/security/xss/script', category: 'security' },
                { id: 'redirect', name: 'Redirect 301', path: '/redirect/301', category: 'features' }
            ];

            // API Testing endpoints for both providers
            const apiEndpoints = [
                { id: 'api-domains', name: 'API: List Domains', path: '/api-test/domains', category: 'api' },
                { id: 'api-domain-details', name: 'API: Domain Details', path: '/api-test/domain-details', category: 'api' },
                { id: 'api-ssl', name: 'API: SSL Settings', path: '/api-test/ssl', category: 'api' },
                { id: 'api-dns', name: 'API: DNS Records', path: '/api-test/dns', category: 'api' },
                { id: 'api-caching', name: 'API: Cache Settings', path: '/api-test/caching', category: 'api' },
                { id: 'api-firewall', name: 'API: Firewall Rules', path: '/api-test/firewall', category: 'api' },
                { id: 'api-analytics', name: 'API: Traffic Reports', path: '/api-test/analytics', category: 'api' }
            ];

            // Return all endpoints for complete testing
            return [...frontendEndpoints, ...apiEndpoints];
        }

        function exportTestReport() {
            if (!window.testResults || window.testResults.length === 0) {
                alert('No test results to export!');
                return;
            }

            // Group results by provider
            const groupedResults = {
                direct: [],
                verge: [],
                arvan: []
            };

            window.testResults.forEach(result => {
                if (result.url.includes('142.93.208.111')) {
                    groupedResults.direct.push(result);
                } else if (result.url.includes('test-verge-test.shop')) {
                    groupedResults.verge.push(result);
                } else if (result.url.includes('test20250316.ir')) {
                    groupedResults.arvan.push(result);
                }
            });

            // Generate detailed report
            let report = `CDN Functionality Test Report\n`;
            report += `Generated: ${new Date().toISOString()}\n\n`;

            for (const [provider, results] of Object.entries(groupedResults)) {
                const providerName = provider === 'direct' ? 'Direct' :
                                   provider === 'verge' ? 'VergeCloud' : 'ArvanCloud';
                const totalTests = results.length;
                const passedTests = results.filter(r => r.success).length;
                const failedTests = totalTests - passedTests;
                const securityBlocked = results.filter(r => r.blockedBySecurity).length;
                const apiTests = results.filter(r => r.isApiTest).length;

                report += `${providerName} Results: ${passedTests}/${totalTests} passed\n`;
                if (apiTests > 0) {
                    report += `API Tests: ${apiTests} endpoints tested\n`;
                }
                if (securityBlocked > 0 && provider === 'arvan') {
                    report += `Security Blocked: ${securityBlocked} (‚úÖ This is GOOD - WAF working!)\n`;
                }
                report += `Failed Tests: ${failedTests - securityBlocked}\n\n`;

                if (failedTests > 0) {
                    const actualFailures = results.filter(r => !r.success && !r.blockedBySecurity);
                    if (actualFailures.length > 0) {
                        report += `ACTUAL FAILURES:\n`;
                        actualFailures.forEach(result => {
                            report += `‚ùå ${result.url}\n`;
                            report += `   Status: ${result.status} ${result.statusText}\n`;
                            if (result.error) {
                                report += `   Error: ${result.error}\n`;
                            }
                            report += `   Duration: ${result.duration}ms\n\n`;
                        });
                    }

                    if (securityBlocked > 0 && provider === 'arvan') {
                        report += `SECURITY BLOCKS (Expected & Good):\n`;
                        results.filter(r => r.blockedBySecurity).forEach(result => {
                            report += `üõ°Ô∏è ${result.url}\n`;
                            report += `   Status: Blocked by ArvanCloud WAF (‚úÖ Security Working!)\n`;
                            report += `   Duration: ${result.duration}ms\n\n`;
                        });
                    }
                }

                // Add API test details
                const apiTestResults = results.filter(r => r.isApiTest);
                if (apiTestResults.length > 0) {
                    report += `API TEST DETAILS:\n`;
                    apiTestResults.forEach(result => {
                        report += `Endpoint: ${result.url}\n`;
                        result.apiResults.forEach(apiResult => {
                            const status = apiResult.success ? '‚úÖ PASS' : '‚ùå FAIL';
                            report += `  ${apiResult.provider}: ${status} (Status: ${apiResult.status})\n`;
                        });
                        report += `Duration: ${result.duration}ms\n\n`;
                    });
                }

                // Add summary stats
                const avgDuration = results.length > 0 ?
                    results.reduce((sum, r) => sum + r.duration, 0) / results.length : 0;
                report += `Average Response Time: ${Math.round(avgDuration)}ms\n\n`;
                report += `‚îÄ`.repeat(50) + `\n\n`;
            }

            // Add raw data for debugging
            report += `RAW TEST RESULTS (JSON):\n`;
            report += JSON.stringify(window.testResults, null, 2);

            // Create and download the file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cdn-test-report-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
