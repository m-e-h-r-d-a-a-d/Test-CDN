<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDN Functionality Tester</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ CDN Functionality Tester</h1>
            <p>Test all VergeCloud and ArvanCloud features with one click</p>
        </div>

        <!-- Main Grid Layout -->
        <div class="main-grid">
            <!-- Left Column: Control Panel -->
            <div class="card">
                <h2>‚öôÔ∏è Test Configuration</h2>

                <div class="control-panel">
                    <!-- Number of Rounds -->
                    <div class="form-group">
                        <label for="rounds">Number of Rounds</label>
                        <input id="rounds" type="number" value="3" min="1" max="10" />
                    </div>

                    <!-- Delay Between Tests -->
                    <div class="form-group">
                        <label for="delay">Delay Between Tests (seconds)</label>
                        <input id="delay" type="number" value="2" min="0" max="10" step="0.5" />
                    </div>

                    <!-- Test Type Selection -->
                    <div>
                        <label style="font-weight: 600; color: #333; margin-bottom: 12px; display: block; font-size: 14px;">Select Test Type</label>
                        <div class="test-types">
                            <label class="test-type-btn">
                                <input type="radio" name="testType" value="performance" checked />
                                <div class="test-type-info">
                                    <h4>‚ö° Performance</h4>
                                    <p>Speed & response time</p>
                                </div>
                            </label>

                            <label class="test-type-btn">
                                <input type="radio" name="testType" value="caching" />
                                <div class="test-type-info">
                                    <h4>üíæ Caching</h4>
                                    <p>Cache behavior & headers</p>
                                </div>
                            </label>

                            <label class="test-type-btn">
                                <input type="radio" name="testType" value="security" />
                                <div class="test-type-info">
                                    <h4>üîí Security</h4>
                                    <p>WAF & security rules</p>
                                </div>
                            </label>

                            <label class="test-type-btn">
                                <input type="radio" name="testType" value="all" />
                                <div class="test-type-info">
                                    <h4>üöÄ All Tests</h4>
                                    <p>Complete test suite</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Run Button -->
                    <button class="btn btn-primary" onclick="startTests()" id="runBtn">
                        ‚ñ∂Ô∏è START TESTS
                    </button>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="card">
                <h2>üìä Results</h2>

                <!-- Progress Section -->
                <div id="progressSection" style="display: none;">
                    <div class="progress-container">
                        <div class="progress-label">
                            <span class="label-text">Testing Progress</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>
                    <div class="status-box">
                        <p class="status-text" id="statusMessage">üîÑ Starting tests...</p>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="results-section">
                    <!-- Summary Cards -->
                    <div class="summary-cards">
                        <div class="summary-card direct">
                            <div class="emoji">üñ•Ô∏è</div>
                            <div class="provider-name">Direct Server</div>
                            <div class="score" id="directScore">0/0</div>
                            <div class="score-label">Features Working</div>
                        </div>

                        <div class="summary-card verge">
                            <div class="emoji">üåê</div>
                            <div class="provider-name">VergeCloud</div>
                            <div class="score" id="vergeScore">0/0</div>
                            <div class="score-label">Features Working</div>
                        </div>

                        <div class="summary-card arvan">
                            <div class="emoji">‚òÅÔ∏è</div>
                            <div class="provider-name">ArvanCloud</div>
                            <div class="score" id="arvanScore">0/0</div>
                            <div class="score-label">Features Working</div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="legend">
                        <h4>Status Indicators:</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-box success"></div>
                                <span>‚úÖ Working</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box warning"></div>
                                <span>‚ö†Ô∏è Issues</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box error"></div>
                                <span>‚ùå Failing</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box loading"></div>
                                <span>‚è≥ Testing</span>
                            </div>
                        </div>
                    </div>

                    <!-- Results Table -->
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Test Category</th>
                                <th style="text-align: center;">Direct</th>
                                <th style="text-align: center;">VergeCloud</th>
                                <th style="text-align: center;">ArvanCloud</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>

                    <!-- Issues Section -->
                    <div class="issues-section" id="issuesSection">
                        <h4>‚ö†Ô∏è Issues Found:</h4>
                        <ul class="issues-list" id="issuesList"></ul>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="location.reload()">
                            üîÑ Test Again
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('resultsSection').classList.remove('active'); document.getElementById('progressSection').style.display='none';">
                            ‚óÄ Back
                        </button>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState">
                    <p style="text-align: center; color: #999; padding: 40px 0;">
                        üëà Configure tests on the left and click START TESTS to begin
                    </p>
                </div>
            </div>
        </div>

        <!-- Quick Links at Bottom -->
        <div style="text-align: center; margin-top: 40px; color: white;">
            <p>üìñ <a href="./tests/manual.html" style="color: white; text-decoration: underline;">Manual Testing Guide</a> ‚Ä¢ 
               üìö <a href="./tests/auto.html" style="color: white; text-decoration: underline;">Advanced Test Runner</a></p>
        </div>
    </div>

    <script>
        async function startTests() {
            const rounds = parseInt(document.getElementById('rounds').value) || 1;
            const delay = parseFloat(document.getElementById('delay').value) || 1;
            const testType = document.querySelector('input[name="testType"]:checked').value;

            const runBtn = document.getElementById('runBtn');
            const progressSection = document.getElementById('progressSection');
            const resultsSection = document.getElementById('resultsSection');
            const emptyState = document.getElementById('emptyState');

            runBtn.disabled = true;
            progressSection.style.display = 'block';
            emptyState.style.display = 'none';
            resultsSection.classList.remove('active');

            try {
                await runTests(testType, rounds, delay);
                resultsSection.classList.add('active');
            } finally {
                runBtn.disabled = false;
                progressSection.style.display = 'none';
            }
        }

        async function runTests(testType, rounds, delay) {
            const endpoints = getEndpoints(testType);
            const providers = [
                { id: 'direct', name: 'Direct', url: 'https://142.93.208.111' },
                { id: 'verge', name: 'VergeCloud', url: 'https://test-verge-test.shop' },
                { id: 'arvan', name: 'ArvanCloud', url: 'https://test20250316.ir' }
            ];

            const times = { direct: [], verge: [], arvan: [] };
            const scores = { direct: 0, verge: 0, arvan: 0 };
            let totalTests = endpoints.length * providers.length * rounds;
            let completedTests = 0;

            const resultsTable = document.getElementById('resultsTable');
            resultsTable.innerHTML = '';

            // Initialize results table
            for (const endpoint of endpoints) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="endpoint">${endpoint.name}</td>
                    <td class="status" id="direct-${endpoint.id}"><span class="status-indicator loading">‚è≥</span></td>
                    <td class="status" id="verge-${endpoint.id}"><span class="status-indicator loading">‚è≥</span></td>
                    <td class="status" id="arvan-${endpoint.id}"><span class="status-indicator loading">‚è≥</span></td>
                `;
                resultsTable.appendChild(row);
            }

            // Run tests
            for (let round = 0; round < rounds; round++) {
                for (const endpoint of endpoints) {
                    for (const provider of providers) {
                        const url = provider.url + endpoint.path;
                        const start = Date.now();
                        const success = await testEndpoint(url);
                        const duration = Date.now() - start;

                        if (success) {
                            times[provider.id].push(duration);
                            scores[provider.id]++;
                            document.getElementById(`${provider.id}-${endpoint.id}`).innerHTML = '<span class="status-indicator success">‚úÖ</span>';
                        } else {
                            document.getElementById(`${provider.id}-${endpoint.id}`).innerHTML = '<span class="status-indicator error">‚ùå</span>';
                        }

                        completedTests++;
                        const progress = Math.round((completedTests / totalTests) * 100);
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressText').textContent = progress + '%';
                        document.getElementById('statusMessage').textContent = `üîÑ Testing ${endpoint.name} on ${provider.name}... (${completedTests}/${totalTests})`;
                    }
                }

                if (round < rounds - 1) {
                    await new Promise(r => setTimeout(r, delay * 1000));
                }
            }

            // Update scores
            const totalPerProvider = endpoints.length * rounds;
            document.getElementById('directScore').textContent = `${scores.direct}/${totalPerProvider}`;
            document.getElementById('vergeScore').textContent = `${scores.verge}/${totalPerProvider}`;
            document.getElementById('arvanScore').textContent = `${scores.arvan}/${totalPerProvider}`;

            document.getElementById('statusMessage').innerHTML = '<span class="status-indicator success">‚úÖ All tests completed!</span>';

            // Check for issues
            const issues = [];
            if (scores.verge < totalPerProvider * 0.7) {
                issues.push('VergeCloud: Multiple tests failing - check configuration');
            }
            if (scores.arvan < totalPerProvider * 0.7) {
                issues.push('ArvanCloud: Multiple tests failing - check configuration');
            }

            const issuesSection = document.getElementById('issuesSection');
            const issuesList = document.getElementById('issuesList');
            if (issues.length > 0) {
                issuesList.innerHTML = issues.map(i => `<li>${i}</li>`).join('');
                issuesSection.classList.add('active');
            } else {
                issuesSection.classList.remove('active');
            }
        }

        async function testEndpoint(url) {
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        function getEndpoints(testType) {
            const all = [
                { id: 'root', name: 'Root Page', path: '/' },
                { id: 'large', name: 'Large File', path: '/large-probe.txt' },
                { id: 'small', name: 'Small File', path: '/probe.txt' },
                { id: 'cache-time', name: 'Cache Headers', path: '/api/time' },
                { id: 'cache-bypass', name: 'Cache Bypass', path: '/cache/bypass/nocache' },
                { id: 'sql', name: 'Security - SQL', path: '/security/sql/union' },
                { id: 'xss', name: 'Security - XSS', path: '/security/xss/script' },
                { id: 'redirect', name: 'Redirect 301', path: '/redirect/301' }
            ];

            if (testType === 'performance') {
                return all.filter(e => ['root', 'large', 'small'].includes(e.id));
            } else if (testType === 'caching') {
                return all.filter(e => ['cache-time', 'cache-bypass'].includes(e.id));
            } else if (testType === 'security') {
                return all.filter(e => ['sql', 'xss'].includes(e.id));
            } else {
                return all;
            }
        }
    </script>
</body>
</html>
